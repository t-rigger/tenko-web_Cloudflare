<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹ã ã¡è¿½åŠ  - ç‚¹å‘¼ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .container {
            text-align: center;
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            position: relative;
        }

        .logout-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            background: #eee;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        h1 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 2rem;
        }

        .subtitle {
            color: #666;
            margin-bottom: 2rem;
        }

        #qr-container {
            margin: 2rem 0;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #status-message {
            color: #e74c3c;
            font-weight: bold;
            font-size: 1.2rem;
            margin-top: 1rem;
            white-space: pre-line;
        }

        .loading {
            color: #667eea;
            font-size: 1.1rem;
        }

        .admin-link {
            margin-top: 2rem;
            text-align: center;
        }

        .admin-link a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border: 2px solid #667eea;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .admin-link a:hover {
            background: #667eea;
            color: white;
        }
    </style>
</head>

<body>
    <div class="container">
        <button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <h1>ğŸ“± LINEå‹ã ã¡è¿½åŠ </h1>
        <p class="subtitle">ä¸‹è¨˜ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„</p>

        <div id="qr-container">
            <p class="loading">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>

        <p id="status-message"></p>

        <div class="admin-link">
            <a href="https://docs.google.com/spreadsheets/d/1WqOsJmpEYnbvMMZAipC_I4ErfMinJKws843xB6G3AIo/"
                target="_blank">ã‚·ãƒ•ãƒˆå…¥åŠ›ã¯ã“ã¡ã‚‰</a>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        let gasConfig = null;

        async function fetchConfig() {
            try {
                const response = await fetch('/api/config');
                gasConfig = await response.json();
            } catch (error) {
                console.error("Failed to fetch config:", error);
            }
        }

        async function loadOptimalQrCode() {
            const qrContainer = document.getElementById('qr-container');
            const statusMessage = document.getElementById('status-message');

            if (!gasConfig) await fetchConfig();

            if (!gasConfig || !gasConfig.gasApiUrl) {
                statusMessage.innerText = 'ã‚¨ãƒ©ãƒ¼: è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚';
                return;
            }

            console.log("Fetching QR from GAS:", gasConfig.gasApiUrl);

            try {
                const response = await fetch(`${gasConfig.gasApiUrl}?action=get_active_qr&api_key=${gasConfig.gasApiKey}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log("GAS Response:", data);

                qrContainer.innerHTML = '';

                if (data.isFull) {
                    qrContainer.innerHTML = '<p style="font-size:3rem;">âš ï¸</p>';
                    statusMessage.innerText = 'å‹é”ç™»éŒ²äººæ•°ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚\nã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºæ‹…å½“è€…ã«ã”é€£çµ¡ãã ã•ã„ã€‚';
                } else if (data.qrUrl) {
                    new QRCode(qrContainer, {
                        text: data.qrUrl,
                        width: 256,
                        height: 256,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel ? QRCode.CorrectLevel.H : 1
                    });
                    statusMessage.innerText = '';
                } else {
                    statusMessage.innerText = 'æœ‰åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
                }
            } catch (error) {
                // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ï¼ˆURLãªã©ï¼‰ã¯è¡¨ç¤ºã—ãªã„
                statusMessage.innerText = 'QRã‚³ãƒ¼ãƒ‰ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
            }
        }

        async function logout() {
            await fetch('/api/logout');
            window.location.href = '/login';
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', loadOptimalQrCode);

        // 5ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°
        setInterval(loadOptimalQrCode, 5000);
    </script>
</body>

</html>